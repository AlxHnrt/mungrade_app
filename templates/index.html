% extends "base.html" %}
{% block content %}
<div class="card" style="margin-bottom:16px">
<h2 style="margin:0 0 10px 0;">Rechercher une entreprise</h2>
<div class="form-grid" style="grid-template-columns: 1fr auto">
<input id="search" type="text" placeholder="Ex : RR.L, Rolls-Royce, SU.PA, GE…">
<button class="btn btn-secondary" type="button" onclick="searchCompany()">Rechercher</button>
</div>
<!-- Affichage nom + logo -->
<div id="company-display" class="company-info" style="display:none; align-items:center; gap:12px; margin-top:12px;">
<img id="company-logo" src="" alt="Logo entreprise" style="width:48px; height:48px; border-radius:6px; background:#fff; object-fit:contain;"
        onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/default_logo.png') }}';">
<span id="company-name" style="font-size:1.05rem; font-weight:600;"></span>
</div>
<div id="prefillMsg" style="margin-top:6px; color:var(--muted)"></div>
</div>
<div class="card">
<h2 style="margin:0 0 10px 0;">Moteur de scoring</h2>
<form method="POST" action="/score-web">
<div class="form-grid">
<div>
<label for="moat">Moat</label>
<select id="moat" name="moat">
<option>Aucun</option>
<option>Faible</option>
<option>Fort</option>
</select>
</div>
<div>
<label for="management">Management</label>
<select id="management" name="management">
<option>Médiocre</option>
<option>Correct</option>
<option>Excellent</option>
</select>
</div>
<div>
<label for="ROE">ROE (%)</label>
<input id="ROE" name="ROE" type="text" inputmode="decimal" placeholder="ex: 18">
</div>
<div>
<label for="DetteEBITDA">Dette / EBITDA</label>
<input id="DetteEBITDA" name="DetteEBITDA" type="text" inputmode="decimal" placeholder="ex: 1.2">
</div>
<div>
<label for="PER">PER</label>
<input id="PER" name="PER" type="text" inputmode="decimal" placeholder="ex: 22">
</div>
</div>
<div style="margin-top:14px;">
<button class="btn btn-primary" type="submit">Calculer</button>
</div>
</form>
</div>
{% if errors %}
<div class="card" style="margin-top:12px; border-color:#b33;">
<strong>Erreurs :</strong>
<ul>
   {% for e in errors %}<li>{{ e }}</li>{% endfor %}
</ul>
</div>
{% endif %}
{% if result %}
<div class="card" style="margin-top:12px;">
<h3>Résultat</h3>
<pre>{{ result | tojson(indent=2) }}</pre>
</div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
async function searchCompany() {
 const q = document.getElementById('search').value.trim();
 const msg = document.getElementById('prefillMsg');
 if(!q){ msg.textContent = "Tape un nom ou un ticker (ex: RR.L)"; return; }
 msg.textContent = "Recherche…";
 try{
   const res = await fetch(`/prefill?q=${encodeURIComponent(q)}`);
   if(!res.ok){
     msg.textContent = "Aucun résultat ("+res.status+")";
     document.getElementById('company-display').style.display = 'none';
     return;
   }
   const js = await res.json();
   if(!js.found){
     msg.textContent = js.message || "Pas de données";
     document.getElementById('company-display').style.display = 'none';
     return;
   }
   const d = js.data;
   // Afficher nom + logo
   const box = document.getElementById('company-display');
   document.getElementById('company-name').textContent = `${d.companyName} — ${d.ticker}`;
   document.getElementById('company-logo').src = d.companyLogo || "{{ url_for('static', filename='images/default_logo.png') }}";
   box.style.display = 'flex';
   // Préremplir champs
   if(d.moat) document.getElementById('moat').value = d.moat;
   if(d.management) document.getElementById('management').value = d.management;
   if(d.ROE !== null) document.getElementById('ROE').value = d.ROE;
   if(d.DetteEBITDA !== null) document.getElementById('DetteEBITDA').value = d.DetteEBITDA;
   if(d.PER !== null) document.getElementById('PER').value = d.PER;
   msg.textContent = "Prérempli ✅";
 }catch(e){
   console.error(e);
   msg.textContent = "Erreur réseau.";
 }
}
</script>
{% endblock %}