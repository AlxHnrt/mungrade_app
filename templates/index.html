{% extends "base.html" %}
{% block title %}MunGrade • Scoring{% endblock %}
{% block content %}
<div class="card" style="margin-bottom:16px">
  <h2 style="margin:0 0 10px 0;">Recherche d’entreprise</h2>
  <div class="form-grid" style="grid-template-columns: 1fr auto">
    <div style="position:relative">
      <input id="prefillQuery" type="text" placeholder="Ex : Rolls-Royce, Schneider, GE, RR.L, SU.PA…" oninput="liveSearch(this.value)">
      <div id="resultsBox" style="position:absolute; left:0; right:0; top:44px; background:#0b0e11; border:1px solid var(--border); border-radius:10px; display:none; z-index:10;"></div>
    </div>
    <button class="btn btn-secondary" type="button" onclick="prefill()">Préremplir</button>
  </div>
  <div id="prefillMsg" style="margin-top:8px; color:var(--muted)"></div>
</div>

<div class="card">
  <h1 style="margin:0 0 12px 0;">Moteur de scoring</h1>
  <p style="margin:0 0 18px 0; color:var(--muted)">
    Évaluez une entreprise selon vos critères fondamentaux.
  </p>
  {% if errors %}
  <div class="card" style="border-color:#3a1f1f;background:#161214;margin-bottom:14px">
    <strong style="color:#fda4af;">Erreurs dans le formulaire :</strong>
    <ul>
      {% for e in errors %}<li>{{ e }}</li>{% endfor %}
    </ul>
  </div>
  {% endif %}
  <form method="post" action="{{ url_for('score_web') }}">
    <div class="form-grid">
      <div>
        <label for="moat">Moat</label>
        <select id="moat" name="moat">
          {% set moat_val = (form.moat if form else 'Fort') %}
          <option {{ 'selected' if moat_val=='Fort' }}>Fort</option>
          <option {{ 'selected' if moat_val=='Faible' }}>Faible</option>
          <option {{ 'selected' if moat_val=='Aucun' }}>Aucun</option>
        </select>
      </div>
      <div>
        <label for="management">Management</label>
        <select id="management" name="management">
          {% set mgmt_val = (form.management if form else 'Excellent') %}
          <option {{ 'selected' if mgmt_val=='Excellent' }}>Excellent</option>
          <option {{ 'selected' if mgmt_val=='Correct' }}>Correct</option>
          <option {{ 'selected' if mgmt_val=='Médiocre' }}>Médiocre</option>
        </select>
      </div>
      <div>
        <label for="ROE">ROE (%)</label>
        <input id="ROE" name="ROE" type="number" step="0.1" value="{{ form.ROE if form else 18 }}">
      </div>
      <div>
        <label for="DetteEBITDA">Dette / EBITDA</label>
        <input id="DetteEBITDA" name="DetteEBITDA" type="number" step="0.1" value="{{ form.DetteEBITDA if form else 1.2 }}">
      </div>
      <div>
        <label for="PER">PER</label>
        <input id="PER" name="PER" type="number" step="0.1" value="{{ form.PER if form else 22 }}">
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-primary" type="submit">Calculer</button>
      <a class="btn btn-secondary" href="{{ url_for('playground') }}">Tester l’API</a>
    </div>
  </form>
</div>

{% if result %}
<div class="card" style="margin-top:16px">
  <h2 style="margin:0 0 8px 0;">Résultat</h2>
  <div style="display:flex;align-items:center;gap:10px">
    <div class="badge {% if result.score>=80 %}ok{% elif result.score>=60 %}warn{% else %}bad{% endif %}">
      {{ result.label }}
    </div>
    <div style="font-size:1.2rem">Score : <strong>{{ result.score }}</strong></div>
  </div>
</div>
{% endif %}

<script>
let _timer=null;
function tplItem(item){
  const label = `${item.symbol} — ${item.name} (${item.exchange||item.type||''})`;
  return `<div class="rs-item" data-symbol="${item.symbol}" onclick="pickSymbol('${item.symbol}','${label.replace(/'/g,'&#39;')}')">${label}</div>`;
}
function liveSearch(q){
  const box = document.getElementById('resultsBox');
  clearTimeout(_timer);
  if(!q || q.length < 2){ box.style.display='none'; box.innerHTML=''; return; }
  _timer = setTimeout(async ()=>{
    try{
      const res = await fetch(`/search?q=${encodeURIComponent(q)}`);
      const js = await res.json();
      if(!js.results || js.results.length===0){ box.style.display='none'; box.innerHTML=''; return; }
      box.innerHTML = js.results.map(tplItem).join('');
      box.style.display = 'block';
    }catch(e){
      box.style.display='none'; box.innerHTML='';
      console.error(e);
    }
  }, 200);
}
function pickSymbol(symbol, label){
  document.getElementById('prefillQuery').value = symbol;
  const box = document.getElementById('resultsBox');
  box.style.display='none'; box.innerHTML='';
  prefill(); // déclenche direct le préremplissage
}
async function prefill(){
  const q = document.getElementById('prefillQuery').value.trim();
  const msg = document.getElementById('prefillMsg');
  msg.textContent = q ? `Recherche ${q}…` : "Tape un nom ou un ticker";
  if(!q) return;
  try{
    const res = await fetch(`/prefill?q=${encodeURIComponent(q)}`);
    if(!res.ok){ msg.textContent = "Aucun résultat ("+res.status+")"; return; }
    const js = await res.json();
    if(js.found){
      const d = js.data;
      document.getElementById('moat').value = d.moat;
      document.getElementById('management').value = d.management;
      if(d.ROE!==null) document.getElementById('ROE').value = d.ROE;
      if(d.DetteEBITDA!==null) document.getElementById('DetteEBITDA').value = d.DetteEBITDA;
      if(d.PER!==null) document.getElementById('PER').value = d.PER;
      msg.textContent = `Prérempli depuis ${d.ticker} ✅`;
    }else{
      msg.textContent = "Pas de données suffisantes.";
    }
  }catch(e){
    console.error(e);
    msg.textContent = "Erreur réseau.";
  }
}
</script>

<style>
.rs-item{ padding:10px 12px; border-bottom:1px solid #151a20; cursor:pointer }
.rs-item:last-child{ border-bottom:none }
.rs-item:hover{ background:#11161c }
</style>
{% endblock %}